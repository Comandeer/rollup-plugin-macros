/*! @comandeer/rollup-plugin-macros v0.1.0 | (c) 2023 Comandeer | MIT license (see LICENSE) */
import{generate as e}from"escodegen";import{walk as r,asyncWalk as t}from"estree-walker";import{writeFile as n}from"node:fs/promises";import{pathToFileURL as o}from"node:url";import{Worker as s}from"node:worker_threads";import{temporaryFile as a}from"tempy";import{dirname as i,resolve as c}from"pathe";async function m(t,i,c){const m=["Literal","ObjectExpression","ArrayExpression"],p=t.callee.name;if(!i.has(p))return;const l=i.get(p),u=t.arguments;if(!u.every((({type:e})=>m.includes(e))))throw new Error("Only macros with arguments of primitive types, object and arrays are supported currently.");const f=await async function({name:r,path:t},i){const c="default"===r?"tempName":r,m=o(t),p=i.map((r=>e(r))).join(", "),l=`import { parentPort } from 'node:worker_threads';\n\timport { ${r} as ${c} } from '${m}';\n\n\tconst result = await ${c}( ${p} );\n\n\tparentPort.postMessage( result );`,u=a({extension:"mjs"});return await n(u,l,"utf-8"),new Promise(((e,r)=>{const t=new s(u);t.on("message",e),t.on("error",r),t.on("exit",(e=>{0!==e&&r(e)}))}))}(l,u),y=function(e){const t=["Literal","ObjectExpression","ArrayExpression"];let n;return r(e,{enter(e){t.includes(e.type)&&(n=e,this.skip())}}),n}(c(`( ${JSON.stringify(f)} )`));this.replace(y)}function p(e,r,t){(function(e){if(!e.assertions)return!1;const[r]=e.assertions;return"type"===r.key.name&&"macro"===r.value.value})(e)&&(!function(e,r,t){const n=i(t),o=c(n,r.source.value);r.specifiers.forEach((r=>{const t="ImportDefaultSpecifier"===r.type?"default":r.imported.name;e.set(r.local.name,{name:t,path:o})}))}(r,e,t),this.remove())}function l(){return{name:"@comandeer/rollup-plugin-macros",resolveId:(e,r,{assertions:t})=>t&&"macro"===t.type?{id:e,external:!0}:null,async transform(r,n){const o=this.parse,s=o(r),a=new Map;return await t(s,{async enter(e){switch(e.type){case"ImportDeclaration":return p.call(this,e,a,n);case"CallExpression":return m.call(this,e,a,o)}}}),{code:e(s)}}}}export{l as default};
//# sourceMappingURL=rollup-plugin-macros.js.map
